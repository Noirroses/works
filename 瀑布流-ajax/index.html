<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        body {margin: 0;}
        #ul1 {width: 1080px; margin: 100px auto 0;}
        li { width: 247px; list-style: none; float: left; margin-right: 10px; }
        li div {border: 1px solid #000; padding: 10px; margin-bottom: 10px;}
        li div img { width: 225px; display: block;}
    </style>
    <script>
        window.onload = function () {

                var oUl = document.getElementById('ul1');
                var aLi = oUl.getElementsByTagName('li');
                var iPage = 1;
                var b = true; //开关
                //初始化数据处理
                getList();
                function getList() {

                    var xhr = null;
                    try{
                        xhr = new XMLHttpRequest();
                    }catch (e){
                        xhr = new ActiveXObject('Microsoft.XMLHTTP');
                    }

                    xhr.open('get','getPics.php?cpage=iPage',true);
                    xhr.send();
                    xhr.onreadystatechange = function () {

                        if(xhr.readyState == 4){
                            if(xhr.status == 200){

                                success(xhr.responseText);//ajax成功后执行的函数

                            }else {
                                alert('Err:' + xhr.status);
                            }
                        }

                }
            }


            function success(data) {


                var data = JSON.parse(data);//将reponseText字符串类型转成json对象

                if(!data.length){//后续没有数据了就从函数中return出来

                    return;
                }

                for(var i = 0;i<data.length;i++){

                    var _index = getShort();// 获取最短的li,每次将图片加载到四列li中高度最短的那个li上
                    var oDiv = document.createElement('div');
                    var oImg = document.createElement('img');
                    oImg.src = data[i].preview;//获取对象的图片地址
                    oImg.style.width = '225px';
                    oImg.style.height = data[i].height * (225/data[i].width)+'px';//防止图片变形,高度宽度按比例
                    oDiv.appendChild(oImg);
                    var oP = document.createElement('p');
                    oP.innerHTML = data[i].title;//获取对象的图片说明
                    oDiv.appendChild(oP);

                    aLi[_index].appendChild(oDiv);//将div追加在最短的那个li上

                }
                b=true;
            }

            //获取最短高度li函数
            function getShort() {
                var index = 0;
                var ih = aLi[index].offsetHeight;
                for(var i = 0;i<aLi.length;i++){
                    if(ih>aLi[i].offsetHeight){
                        index = i;
                        ih = aLi[i].offsetHeight;
                    }
                }
                return index; //返回索引值
            }

            //滚轮滚动事件
            window.onscroll = function () {

                var _index = getShort();
                var oLi = aLi[_index];
                var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;

                if(getTop(oLi) + oLi.offsetHeight < document.documentElement.clientHeight + scrollTop){
                    if(b){
                        b=false;//保证在遇到最短li底部之前滚轮滑动不会再次执行getList(),直到遇到最短li后在执行getList()中将b变为true
                        iPage++; // 数据的页数增加
                        getList();
                    }
                }
            }
            //获取到文档顶部距离
            function getTop(obj) {
                var iTop = 0;
                while(obj){
                    iTop += obj.offsetTop;
                    obj = obj.offsetParent;
                }
                return iTop;
            }
        }


    </script>
</head>
<body>
    <ul id="ul1">
        <li></li>
        <li></li>
        <li></li>
        <li></li>
    </ul>
</body>
</html>